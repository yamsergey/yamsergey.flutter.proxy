# Publishes package to pub.dev when a version tag is pushed
# Tag format: x.x.x or x.x.x-description (e.g., 1.0.0, 1.0.0-beta, 1.0.0-nullsafe)
#
# Setup required:
# 1. Go to https://pub.dev/packages/platform_proxy/admin
# 2. Enable "Automated publishing" from GitHub Actions
# 3. Add repository: yamsergey/yamsergey.flutter.proxy
#
# See: https://dart.dev/tools/pub/automated-publishing

name: Publish to pub.dev

on:
  push:
    tags:
      # Matches: 1.0.0, 1.2.3, 0.9.3, etc.
      - '[0-9]+.[0-9]+.[0-9]+'
      # Matches: 1.0.0-beta, 1.0.0-nullsafe, 0.9.3-rc1, etc.
      - '[0-9]+.[0-9]+.[0-9]+-*'

jobs:
  publish:
    name: Publish to pub.dev
    runs-on: ubuntu-latest
    
    # Configures the environment for OIDC-based authentication with pub.dev
    environment: pub.dev
    
    permissions:
      id-token: write  # Required for OIDC token authentication with pub.dev
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@v1

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Verify Flutter installation
        run: flutter --version

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze

      - name: Run tests
        run: flutter test

      - name: Verify package score
        run: dart pub publish --dry-run

      - name: Publish to pub.dev
        run: dart pub publish --force
